"""
1. –ü–û–î–ì–û–¢–û–í–ö–ê –î–û–ö–£–ú–ï–ù–¢–û–í –î–õ–Ø RAG

–ß—Ç–æ –¥–µ–ª–∞–µ–º:
1. –ë–µ—Ä–µ–º —Ç–µ–∫—Å—Ç–æ–≤—ã–µ –¥–æ–∫—É–º–µ–Ω—Ç—ã (—Å—Ç–∞—Ç—å–∏, –∫–Ω–∏–≥–∏, –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—é)
2. –ß–∏—Å—Ç–∏–º –∏—Ö (—É–±–∏—Ä–∞–µ–º –º—É—Å–æ—Ä)
3. –†–∞–∑–±–∏–≤–∞–µ–º –Ω–∞ –æ—Å–º—ã—Å–ª–µ–Ω–Ω—ã–µ –∫—É—Å–∫–∏ (—á–∞–Ω–∫–∏)
4. –ì–æ—Ç–æ–≤–∏–º –¥–ª—è –ø–æ–∏—Å–∫–∞

–ü–æ—á–µ–º—É —ç—Ç–æ –≤–∞–∂–Ω–æ:
–ü–ª–æ—Ö–æ —Ä–∞–∑–±–∏—Ç—ã–π –¥–æ–∫—É–º–µ–Ω—Ç = AI –Ω–µ –Ω–∞–π–¥–µ—Ç –Ω—É–∂–Ω—É—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é
–•–æ—Ä–æ—à–æ —Ä–∞–∑–±–∏—Ç—ã–π –¥–æ–∫—É–º–µ–Ω—Ç = AI –Ω–∞–π–¥–µ—Ç —Ç–æ—á–Ω—ã–π –æ—Ç–≤–µ—Ç
"""

print("=" * 60)
print("–®–ê–ì 1: –ü–û–î–ì–û–¢–û–í–ö–ê –î–û–ö–£–ú–ï–ù–¢–û–í")
print("=" * 60)

# –°–æ–∑–¥–∞–µ–º —Ç–µ—Å—Ç–æ–≤—ã–µ –¥–æ–∫—É–º–µ–Ω—Ç—ã (–≤ —Ä–µ–∞–ª—å–Ω–æ—Å—Ç–∏ –∑–∞–≥—Ä—É–∂–∞–µ–º –∏–∑ —Ñ–∞–π–ª–æ–≤)
# –≠—Ç–æ –±—É–¥—É—Ç —Å—Ç–∞—Ç—å–∏ –æ –º–∞—à–∏–Ω–Ω–æ–º –æ–±—É—á–µ–Ω–∏–∏

documents = [
    """
    –ú–∞—à–∏–Ω–Ω–æ–µ –æ–±—É—á–µ–Ω–∏–µ (Machine Learning, ML) ‚Äî —ç—Ç–æ –ø–æ–¥—Ä–∞–∑–¥–µ–ª –∏—Å–∫—É—Å—Å—Ç–≤–µ–Ω–Ω–æ–≥–æ –∏–Ω—Ç–µ–ª–ª–µ–∫—Ç–∞, 
    –∫–æ—Ç–æ—Ä—ã–π –∏–∑—É—á–∞–µ—Ç –∞–ª–≥–æ—Ä–∏—Ç–º—ã, —Å–ø–æ—Å–æ–±–Ω—ã–µ –æ–±—É—á–∞—Ç—å—Å—è –Ω–∞ –¥–∞–Ω–Ω—ã—Ö. –í–º–µ—Å—Ç–æ —Ç–æ–≥–æ —á—Ç–æ–±—ã –ø–∏—Å–∞—Ç—å 
    –ø—Ä–∞–≤–∏–ª–∞ –≤—Ä—É—á–Ω—É—é, –º—ã –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –∫–æ–º–ø—å—é—Ç–µ—Ä—É –ø—Ä–∏–º–µ—Ä—ã, –∏ –æ–Ω —Å–∞–º –Ω–∞—Ö–æ–¥–∏—Ç –∑–∞–∫–æ–Ω–æ–º–µ—Ä–Ω–æ—Å—Ç–∏.

    –û—Å–Ω–æ–≤–Ω—ã–µ —Ç–∏–ø—ã –º–∞—à–∏–Ω–Ω–æ–≥–æ –æ–±—É—á–µ–Ω–∏—è:
    1. –û–±—É—á–µ–Ω–∏–µ —Å —É—á–∏—Ç–µ–ª–µ–º (Supervised Learning) ‚Äî —É –Ω–∞—Å –µ—Å—Ç—å –ø—Ä–∞–≤–∏–ª—å–Ω—ã–µ –æ—Ç–≤–µ—Ç—ã
    2. –û–±—É—á–µ–Ω–∏–µ –±–µ–∑ —É—á–∏—Ç–µ–ª—è (Unsupervised Learning) ‚Äî –∏—â–µ–º —Å–∫—Ä—ã—Ç—ã–µ —Å—Ç—Ä—É–∫—Ç—É—Ä—ã
    3. –û–±—É—á–µ–Ω–∏–µ —Å –ø–æ–¥–∫—Ä–µ–ø–ª–µ–Ω–∏–µ–º (Reinforcement Learning) ‚Äî —É—á–∏–º—Å—è –Ω–∞ –Ω–∞–≥—Ä–∞–¥–∞—Ö
    """,
    """ RAG —Ç–∞–∫ —Å–µ–±–µ –º–Ω–µ –Ω—Ä–∞–≤–∏—Ç—Å—è CHAT GPT —ç—Ç–æ –∏—Å—Ç–∏–Ω–∞ RAG —ç—Ç–æ –º—É–∂–µ—Å—Ç–≤–æ –∏ —Å–∏–ª–∞""",

    """
    –ì–ª—É–±–æ–∫–æ–µ –æ–±—É—á–µ–Ω–∏–µ (Deep Learning) ‚Äî —ç—Ç–æ –æ—Å–æ–±—ã–π –≤–∏–¥ –º–∞—à–∏–Ω–Ω–æ–≥–æ –æ–±—É—á–µ–Ω–∏—è, 
    –∫–æ—Ç–æ—Ä—ã–π –∏—Å–ø–æ–ª—å–∑—É–µ—Ç –Ω–µ–π—Ä–æ–Ω–Ω—ã–µ —Å–µ—Ç–∏ —Å –º–Ω–æ–∂–µ—Å—Ç–≤–æ–º —Å–ª–æ–µ–≤. –≠—Ç–∏ —Å–µ—Ç–∏ —É–º–µ—é—Ç 
    –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –∏–∑–≤–ª–µ–∫–∞—Ç—å –ø—Ä–∏–∑–Ω–∞–∫–∏ –∏–∑ –¥–∞–Ω–Ω—ã—Ö.

    –ü—Ä–∏–º–µ—Ä—ã –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—è:
    - –†–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π (–∫–æ—Ç—ã, —Å–æ–±–∞–∫–∏, –ª–∏—Ü–∞)
    - –û–±—Ä–∞–±–æ—Ç–∫–∞ –µ—Å—Ç–µ—Å—Ç–≤–µ–Ω–Ω–æ–≥–æ —è–∑—ã–∫–∞ (–ø–µ—Ä–µ–≤–æ–¥, –∞–Ω–∞–ª–∏–∑ —Ç–æ–Ω–∞–ª—å–Ω–æ—Å—Ç–∏)
    - –ì–µ–Ω–µ—Ä–∞—Ü–∏—è —Ç–µ–∫—Å—Ç–∞ –∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π
    """,

    """
    –¢—Ä–∞–Ω—Å—Ñ–æ—Ä–º–µ—Ä—ã (Transformers) ‚Äî –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ –Ω–µ–π—Ä–æ–Ω–Ω—ã—Ö —Å–µ—Ç–µ–π, –∫–æ—Ç–æ—Ä–∞—è 
    —Ä–µ–≤–æ–ª—é—Ü–∏–æ–Ω–∏–∑–∏—Ä–æ–≤–∞–ª–∞ –æ–±—Ä–∞–±–æ—Ç–∫—É —Ç–µ–∫—Å—Ç–∞. –í–ø–µ—Ä–≤—ã–µ –ø—Ä–µ–¥—Å—Ç–∞–≤–ª–µ–Ω–∞ –≤ 2017 –≥–æ–¥—É.

    –ö–ª—é—á–µ–≤—ã–µ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã:
    1. –ú–µ—Ö–∞–Ω–∏–∑–º –≤–Ω–∏–º–∞–Ω–∏—è (Attention) ‚Äî —Å–º–æ—Ç—Ä–∏—Ç –Ω–∞ –≤—Å–µ —Å–ª–æ–≤–∞ —Å—Ä–∞–∑—É
    2. –ü–æ–∑–∏—Ü–∏–æ–Ω–Ω–æ–µ –∫–æ–¥–∏—Ä–æ–≤–∞–Ω–∏–µ ‚Äî –∑–∞–ø–æ–º–∏–Ω–∞–µ—Ç –ø–æ—Ä—è–¥–æ–∫ —Å–ª–æ–≤
    3. –ú–Ω–æ–≥–æ—Å–ª–æ–π–Ω–æ—Å—Ç—å ‚Äî –Ω–µ—Å–∫–æ–ª—å–∫–æ —É—Ä–æ–≤–Ω–µ–π –æ–±—Ä–∞–±–æ—Ç–∫–∏

    –ü—Ä–∏–º–µ—Ä—ã –º–æ–¥–µ–ª–µ–π: BERT, GPT, T5
    """,

    """
    RAG (Retrieval-Augmented Generation) ‚Äî —ç—Ç–æ –ø–æ–¥—Ö–æ–¥, –∫–æ—Ç–æ—Ä—ã–π —Å–æ—á–µ—Ç–∞–µ—Ç 
    –ø–æ–∏—Å–∫ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –∏ –≥–µ–Ω–µ—Ä–∞—Ü–∏—é —Ç–µ–∫—Å—Ç–∞. –°–Ω–∞—á–∞–ª–∞ —Å–∏—Å—Ç–µ–º–∞ –∏—â–µ—Ç —Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω—ã–µ 
    –¥–æ–∫—É–º–µ–Ω—Ç—ã, –∑–∞—Ç–µ–º –∏—Å–ø–æ–ª—å–∑—É–µ—Ç –∏—Ö –¥–ª—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –æ—Ç–≤–µ—Ç–∞.

    –ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞ RAG:
    - –ú–µ–Ω—å—à–µ "–≥–∞–ª–ª—é—Ü–∏–Ω–∞—Ü–∏–π" (–≤—ã–¥—É–º—ã–≤–∞–Ω–∏—è —Ñ–∞–∫—Ç–æ–≤)
    - –ú–æ–∂–Ω–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —Å–≤–µ–∂–∏–µ –¥–∞–Ω–Ω—ã–µ
    - –ü—Ä–æ–∑—Ä–∞—á–Ω–æ—Å—Ç—å (–≤–∏–¥–Ω–æ, –æ—Ç–∫—É–¥–∞ –≤–∑—è—Ç–∞ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è)
    """
]

print(f"–£ –Ω–∞—Å –µ—Å—Ç—å {len(documents)} –¥–æ–∫—É–º–µ–Ω—Ç–∞ –æ –º–∞—à–∏–Ω–Ω–æ–º –æ–±—É—á–µ–Ω–∏–∏")
print("\n–ü—Ä–∏–º–µ—Ä –ø–µ—Ä–≤–æ–≥–æ –¥–æ–∫—É–º–µ–Ω—Ç–∞:")
print("-" * 40)
print(documents[0][:200] + "...")  # –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –ø–µ—Ä–≤—ã–µ 200 —Å–∏–º–≤–æ–ª–æ–≤
print("-" * 40)


# –§—É–Ω–∫—Ü–∏—è –¥–ª—è —É–º–Ω–æ–≥–æ —Ä–∞–∑–±–∏–µ–Ω–∏—è —Ç–µ–∫—Å—Ç–∞ –Ω–∞ —á–∞–Ω–∫–∏
def smart_chunking(text, chunk_size=300, overlap=50):
    """
    –†–∞–∑–±–∏–≤–∞–µ—Ç —Ç–µ–∫—Å—Ç –Ω–∞ —á–∞–Ω–∫–∏, —Å—Ç–∞—Ä–∞—è—Å—å –Ω–µ —Ä–µ–∑–∞—Ç—å –ø–æ —Å–º—ã—Å–ª—É

    chunk_size: –º–∞–∫—Å–∏–º–∞–ª—å–Ω—ã–π —Ä–∞–∑–º–µ—Ä —á–∞–Ω–∫–∞ –≤ —Å–∏–º–≤–æ–ª–∞—Ö
    overlap: –ø–µ—Ä–µ–∫—Ä—ã—Ç–∏–µ –º–µ–∂–¥—É —á–∞–Ω–∫–∞–º–∏ (—á—Ç–æ–±—ã –Ω–µ —Ç–µ—Ä—è—Ç—å –∫–æ–Ω—Ç–µ–∫—Å—Ç)
    """

    print(f"\n–†–∞–∑–±–∏–≤–∞–µ–º —Ç–µ–∫—Å—Ç –Ω–∞ —á–∞–Ω–∫–∏...")
    print(f"–†–∞–∑–º–µ—Ä —á–∞–Ω–∫–∞: {chunk_size} —Å–∏–º–≤–æ–ª–æ–≤")
    print(f"–ü–µ—Ä–µ–∫—Ä—ã—Ç–∏–µ: {overlap} —Å–∏–º–≤–æ–ª–æ–≤")

    chunks = []

    # –ü—Ä–æ—Å—Ç–æ–µ —Ä–∞–∑–±–∏–µ–Ω–∏–µ –ø–æ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è–º –¥–ª—è –Ω–∞—á–∞–ª–∞
    sentences = text.replace('\n', ' ').split('. ')

    current_chunk = ""

    for sentence in sentences:
        # –ï—Å–ª–∏ –¥–æ–±–∞–≤–ª—è—è –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ –Ω–µ –ø—Ä–µ–≤—ã—à–∞–µ–º —Ä–∞–∑–º–µ—Ä —á–∞–Ω–∫–∞
        if len(current_chunk) + len(sentence) < chunk_size:
            current_chunk += sentence + ". "
        else:
            # –°–æ—Ö—Ä–∞–Ω—è–µ–º —á–∞–Ω–∫ –∏ –Ω–∞—á–∏–Ω–∞–µ–º –Ω–æ–≤—ã–π —Å –ø–µ—Ä–µ–∫—Ä—ã—Ç–∏–µ–º
            if current_chunk:
                chunks.append(current_chunk.strip())

            # –î–ª—è –ø–µ—Ä–µ–∫—Ä—ã—Ç–∏—è –±–µ—Ä–µ–º –∫–æ–Ω–µ—Ü –ø—Ä–µ–¥—ã–¥—É—â–µ–≥–æ —á–∞–Ω–∫–∞
            words = current_chunk.split()
            overlap_text = " ".join(words[-10:])  # –ü–æ—Å–ª–µ–¥–Ω–∏–µ 10 —Å–ª–æ–≤

            current_chunk = overlap_text + " " + sentence + ". "

    # –î–æ–±–∞–≤–ª—è–µ–º –ø–æ—Å–ª–µ–¥–Ω–∏–π —á–∞–Ω–∫
    if current_chunk:
        chunks.append(current_chunk.strip())

    print(f"–ü–æ–ª—É—á–∏–ª–æ—Å—å {len(chunks)} —á–∞–Ω–∫–æ–≤")
    print("\n–ü—Ä–∏–º–µ—Ä —á–∞–Ω–∫–∞:")
    print("-" * 40)
    if chunks:
        print(chunks[0][:150] + "...")
    print("-" * 40)

    return chunks


# –†–∞–∑–±–∏–≤–∞–µ–º –≤—Å–µ –¥–æ–∫—É–º–µ–Ω—Ç—ã –Ω–∞ —á–∞–Ω–∫–∏
all_chunks = []
chunk_info = []  # –•—Ä–∞–Ω–∏–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ —á–∞–Ω–∫–∞—Ö (–∏–∑ –∫–∞–∫–æ–≥–æ –¥–æ–∫—É–º–µ–Ω—Ç–∞)

for doc_id, doc in enumerate(documents):
    print(f"\n–û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º –¥–æ–∫—É–º–µ–Ω—Ç {doc_id + 1}:")
    chunks = smart_chunking(doc, chunk_size=300, overlap=50)

    for chunk_id, chunk in enumerate(chunks):
        all_chunks.append(chunk)
        chunk_info.append({
            "doc_id": doc_id,
            "chunk_id": chunk_id,
            "doc_title": f"–î–æ–∫—É–º–µ–Ω—Ç {doc_id + 1}",
            "chunk_text": chunk[:100] + "..." if len(chunk) > 100 else chunk
        })

print(f"\n" + "=" * 60)
print(f"–ò–¢–û–ì–û: {len(all_chunks)} —á–∞–Ω–∫–æ–≤ –≥–æ—Ç–æ–≤—ã –∫ —Ä–∞–±–æ—Ç–µ")
print("=" * 60)

# –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É
print("\nüìä –°–¢–ê–¢–ò–°–¢–ò–ö–ê –ü–û –ß–ê–ù–ö–ê–ú:")
print(f"–í—Å–µ–≥–æ —á–∞–Ω–∫–æ–≤: {len(all_chunks)}")

# –°—Ä–µ–¥–Ω—è—è –¥–ª–∏–Ω–∞ —á–∞–Ω–∫–∞
avg_length = sum(len(c) for c in all_chunks) / len(all_chunks)
print(f"–°—Ä–µ–¥–Ω—è—è –¥–ª–∏–Ω–∞ —á–∞–Ω–∫–∞: {avg_length:.0f} —Å–∏–º–≤–æ–ª–æ–≤")

# –†–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –ø–æ –¥–æ–∫—É–º–µ–Ω—Ç–∞–º
from collections import Counter

doc_counts = Counter(info["doc_id"] for info in chunk_info)
print("\n–ß–∞–Ω–∫–æ–≤ –ø–æ –¥–æ–∫—É–º–µ–Ω—Ç–∞–º:")
for doc_id, count in sorted(doc_counts.items()):
    print(f"  –î–æ–∫—É–º–µ–Ω—Ç {doc_id + 1}: {count} —á–∞–Ω–∫–æ–≤")

# –°–æ—Ö—Ä–∞–Ω—è–µ–º —á–∞–Ω–∫–∏ –¥–ª—è —Å–ª–µ–¥—É—é—â–µ–≥–æ —à–∞–≥–∞
print("\nüíæ –°–æ—Ö—Ä–∞–Ω—è–µ–º —á–∞–Ω–∫–∏ –¥–ª—è —Å–ª–µ–¥—É—é—â–µ–≥–æ —ç—Ç–∞–ø–∞...")

# –ü—Ä–æ—Å—Ç–æ —Å–æ—Ö—Ä–∞–Ω—è–µ–º –≤ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ (–≤ —Ä–µ–∞–ª—å–Ω–æ–º –ø—Ä–æ–µ–∫—Ç–µ - –≤ —Ñ–∞–π–ª)
rag_data = {
    "chunks": all_chunks,
    "chunk_info": chunk_info,
    "original_docs": documents
}

print("‚úÖ –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –¥–∞–Ω–Ω—ã—Ö –∑–∞–≤–µ—Ä—à–µ–Ω–∞!")
print("\n–ß—Ç–æ –º—ã —Å–¥–µ–ª–∞–ª–∏:")
print("1. –í–∑—è–ª–∏ 4 –¥–æ–∫—É–º–µ–Ω—Ç–∞ –æ ML")
print("2. –†–∞–∑–±–∏–ª–∏ –∏—Ö –Ω–∞ 12 –æ—Å–º—ã—Å–ª–µ–Ω–Ω—ã—Ö —á–∞–Ω–∫–æ–≤")
print("3. –°–æ—Ö—Ä–∞–Ω–∏–ª–∏ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –∫–∞–∂–¥–æ–º —á–∞–Ω–∫–µ")
print("4. –ì–æ—Ç–æ–≤—ã –∫ —Å–æ–∑–¥–∞–Ω–∏—é –≤–µ–∫—Ç–æ—Ä–Ω—ã—Ö –ø—Ä–µ–¥—Å—Ç–∞–≤–ª–µ–Ω–∏–π")


import pickle

# –°–æ—Ö—Ä–∞–Ω—è–µ–º rag_data –≤ —Ñ–∞–π–ª
with open('rag_data_step1.pkl', 'wb') as f:
    pickle.dump(rag_data, f)

print("\nüíæ –î–∞–Ω–Ω—ã–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã –≤ —Ñ–∞–π–ª 'rag_data_step1.pkl'")
print("–¢–µ–ø–µ—Ä—å –º–æ–∂–Ω–æ –∑–∞–ø—É—Å–∫–∞—Ç—å 2_embedding_visual.py")